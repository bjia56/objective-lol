name: Release

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to release'
        required: true
        type: choice
        options:
          - main
          - python
          - vscode
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  validate-tag:
    name: Validate Tag
    runs-on: ubuntu-latest
    outputs:
      tag-name: ${{ steps.set-tag.outputs.tag-name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ "$VERSION" =~ ^v ]]; then
            echo "Error: Version should not start with 'v' (got: $VERSION)"
            echo "Please provide version number only (e.g., '1.0.0' not 'v1.0.0')"
            exit 1
          fi
          echo "Version format is valid: $VERSION"

      - name: Validate component version
        run: |
          VERSION="${{ inputs.version }}"
          COMPONENT="${{ inputs.component }}"

          case "$COMPONENT" in
            "python")
              # Check if setup.py contains the version
              if ! grep -q "version=\"$VERSION\"" python/setup.py; then
                echo "Error: python/setup.py does not contain version=\"$VERSION\""
                echo "Current version in setup.py:"
                grep "version=" python/setup.py || echo "No version found"
                echo "Please update setup.py with the correct version before releasing"
                exit 1
              fi
              echo "Python version validation passed"
              ;;
            "vscode")
              # Check if package.json contains the version
              if ! grep -q "\"version\": \"$VERSION\"" vscode-extension/package.json; then
                echo "Error: vscode-extension/package.json does not contain \"version\": \"$VERSION\""
                echo "Current version in package.json:"
                grep "\"version\":" vscode-extension/package.json || echo "No version found"
                echo "Please update package.json with the correct version before releasing"
                exit 1
              fi
              echo "VSCode version validation passed"
              ;;
            "main")
              echo "No version file validation needed for main component"
              ;;
          esac

      - name: Set tag name
        id: set-tag
        run: |
          case "${{ inputs.component }}" in
            "main")
              TAG_NAME="v${{ inputs.version }}"
              ;;
            "python")
              TAG_NAME="python-v${{ inputs.version }}"
              ;;
            "vscode")
              TAG_NAME="vscode-v${{ inputs.version }}"
              ;;
          esac
          echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Generated tag name: $TAG_NAME"

      - name: Check if tag exists
        run: |
          TAG_NAME="${{ steps.set-tag.outputs.tag-name }}"
          if git tag -l | grep -q "^${TAG_NAME}$"; then
            echo "Error: Tag $TAG_NAME already exists"
            exit 1
          fi
          echo "Tag $TAG_NAME is available"

  build:
    name: Build Components
    needs: validate-tag
    uses: ./.github/workflows/build.yml

  release-main:
    if: inputs.component == 'main'
    needs: [validate-tag, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release assets directory
        run: mkdir -p release-assets

      - name: Prepare release assets
        run: |
          # Copy and rename Go binaries
          for dir in artifacts/olol-*; do
            if [ -d "$dir" ]; then
              cp "$dir"/* release-assets/
            fi
          done

          # Copy and rename LSP binaries
          for dir in artifacts/olol-lsp-*; do
            if [ -d "$dir" ]; then
              cp "$dir"/* release-assets/
            fi
          done

          # List what we have
          echo "Release assets:"
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-tag.outputs.tag-name }}
          name: "${{ needs.validate-tag.outputs.tag-name }}"
          draft: false
          prerelease: false
          files: release-assets/*
          body: |
            ## Objective-LOL ${{ inputs.version }}

            ### Downloads
            - **olol**: Main interpreter binary
            - **olol-lsp**: Language Server Protocol implementation

            Available for Windows (amd64/arm64), macOS (amd64/arm64), and Linux (amd64/arm64).

            ### Installation
            1. Download the appropriate binary for your platform
            2. Make it executable (Unix systems): `chmod +x olol-*`
            3. Run: `./olol-<platform> your-program.olol`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-python:
    if: inputs.component == 'python'
    needs: [validate-tag, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Python wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: wheels
          merge-multiple: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Prepare all distributions
        run: |
          mkdir -p dist-all
          # Copy wheels from artifacts
          find wheels -name "*.whl" -exec cp {} dist-all/ \;
          # Copy source distribution
          cp python/dist/*.tar.gz dist-all/

          echo "Distribution files:"
          ls -la dist-all/

      - name: Check distributions
        run: |
          python -m twine check dist-all/*

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          python -m twine upload dist-all/*

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-tag.outputs.tag-name }}
          name: "${{ needs.validate-tag.outputs.tag-name }}"
          draft: false
          prerelease: false
          files: dist-all/*
          body: |
            ## Objective-LOL Python Package ${{ inputs.version }}

            Python bindings for the Objective-LOL interpreter.

            ### Installation
            ```bash
            pip install objective-lol
            ```

            ### Usage
            ```python
            import objective_lol

            # Run Objective-LOL code
            result = objective_lol.run("""
            I CAN HAS STDIO?
            HAI ME TEH FUNCSHUN MAIN
                SAYZ WIT "Hello World!"
            KTHXBAI
            """)
            ```

            ### What's included
            - Pre-built wheels for Windows, macOS, and Linux
            - Support for Python 3.9+
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # release-vscode:
  #   if: inputs.component == 'vscode'
  #   needs: [validate-tag, build]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Publish to VS Code Marketplace
  #       run: echo "TODO: Publish VSCode extension to marketplace"